<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Due payment list</title>
    <link href="css/i3.css" rel="stylesheet">
    <style>
/* Basic styles for the container */
.installation-form {
            position: relative; /* Position relative for dropdown */
            max-width: 380px;
            margin: 20px auto;
            display: flex;
            gap: 15px;
        }
        /* Mobile view adjustments */
@media (max-width: 600px) {
    .installation-form {
        max-width: 100%;  /* Full width on mobile */
        margin: 10px;     /* Reduce margin on mobile */
        padding: 15px;    /* Adjust padding for mobile */
        display: block;
    }
}

        /* Base styles for suggestions dropdown */
#suggestions-list {
    border: 0px solid #ccc; /* Use solid border */
    max-height: 150px; /* Set a reasonable max height */
    overflow-y: auto;
    list-style-type: none;
    padding: 0;
    margin: 0;
    position: absolute;
    background-color: white;
    z-index: 1000;
    width: calc(52% - 20px); /* Match input box width */
    top: 59%; /* Position directly below the input */
    left: 180px; /* Align with left side of the input */
}

/* Style for each suggestion */
#suggestions-list li {
    padding: 10px; /* Add padding */
    cursor: pointer; /* Change cursor to pointer */
}

/* Highlight suggestions on hover */
#suggestions-list li:hover {
    background-color: #f0f0f0; /* Highlight on hover */
}

/* Mobile-specific styles */
@media (max-width: 600px) {
    #suggestions-list {
        width: calc(100% - 2px); /* Maintain full width for mobile */
        left: 0; /* Align with left side of the input */
        max-height: 120px; /* Adjust max height for mobile */
        top: 100%;
    }

    #customer-name {
        width: 100%; /* Ensure the input takes full width on mobile */
    }

    .form-group {
        position: relative; /* Ensure suggestions list positions correctly */
        margin-bottom: 15px; /* Add space between form groups */
        display: block;
    }
}

        /* Navbar links */
    .navbar-links {
            display: ruby-text;
            list-style-type: none;
            gap: 22px; /* Adds space between each menu item */
        }

        

        .navbar-links a {
            text-decoration: none;
            color: white;
            padding: 8px 11px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        /* Mobile View */
        @media (max-width: 768px) {
            .navbar-links {
                flex-direction: column; /* Stack items vertically */
                gap: 0px;
            }
            .navbar-item.left {
    flex: 0 1 88%;
    display: flex;
    align-items: center;
    padding-left: 15px;
}
            .navbar-links li {
                margin-bottom: 0px; /* Optional, adds space between menu items in mobile view */
                margin-right: 0px;
            }
        }
        /* Overlay for Popup */
    #popupOverlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }
    

.menu-btn {
    display: none;
    font-size: 30px;
    background: none;
    color: white;
    border: none;
    cursor: pointer;
}

@media (max-width: 768px) {
    .navbar-links {
        display: none;
        flex-direction: column;
        position: absolute;
        top: 45px;
        left: 100px;
        width: 100%;
        text-align: center;
    }

    .navbar-links.show {
        display: flex;
    }

    .menu-btn {
        display: block;
        margin-bottom: 50px;
    }
}

    </style>
</head>
<body>
    <header class="navbar">
        <div class="navbar-item left">
            <img src="img/Alisom Logo .png" alt="Logo" class="logo">
        </div>
        <div>
          <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
            <ul class="navbar-links">
                <li><a href="index.html">Login</a></li>
                <li><a href="Add_client.html">Add Client</a></li>
                <li><a href="Due-Payment.html">Due Payment</a></li>
                <li><a href="search.html">Search</a></li>
            </ul>
        </div>
        <div class="navbar-item middle"></div>
        <div class="navbar-item right"></div>
    </header>
    <br><br>
    <header class="sub-navbar">
        <div class="navbar-item left" style="display: flex; justify-content: center; align-items: center;">
            <h3 style="margin: 0; color:#00bfa6 ;">Customers having due on Payment</h3>
        </div>
        <div class="navbar-item middle"></div>
        <div class="navbar-item right"></div>
    </header>
    
    <div id="search-results"></div> 
 
<script>
    function toggleMenu() {
    const navbarLinks = document.querySelector('.navbar-links');
    navbarLinks.classList.toggle('show');
}

</script>    
<script>
    // Function to get a specific cookie by name
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Retrieve the token from cookies
    const token = getCookie('token');

    const myHeaders = new Headers();
    myHeaders.append("Authorization", `${token}`); // Use token from cookies
    myHeaders.append("Content-Type", "application/json");

    // Utility function to parse 'field1' and extract 'dueDate'
    function getDueDate(field1) {
        if (typeof field1 === 'string') {
            try {
                // Parse the stringified array
                const parsedField = JSON.parse(field1);
                if (Array.isArray(parsedField)) {
                    const dueDateObj = parsedField.find(item => item.dueDate && item.dueDate !== "");
                    return dueDateObj ? dueDateObj.dueDate : null;
                }
            } catch (error) {
                console.error("Error parsing field1:", error);
            }
        }
        return null;
    }

    // Fetch customer names from the API
    fetch("https://api2.itstrending.in/api/v1/profiles/search_multiple", {
        method: "POST",
        headers: myHeaders,
        body: JSON.stringify({ "field48": "" }),
        redirect: "follow"
    })
    .then((response) => {
        console.log('Response received:', response);
        return response.json();
    })
    .then((result) => {
        // Extract profiles from the result
        const profiles = result.data.profile;
        console.log('Profiles fetched:', profiles);

        // Filter profiles based on "dueDate" inside "field1" array
        const filteredProfiles = profiles.filter(profile => {
            const dueDate = getDueDate(profile.field1);
            console.log(`Profile ${profile.field2} has dueDate:`, dueDate);
            return dueDate;  // Only fetch profiles with a valid dueDate
        });

        // Display the filtered profiles on the webpage
        const searchResultsDiv = document.getElementById('search-results');
        searchResultsDiv.innerHTML = ''; // Clear previous results if any

        filteredProfiles.forEach(profile => {
            const dueDate = getDueDate(profile.field1);
            
            // Create a div element for each profile
            const profileElement = document.createElement('div');
            profileElement.className = 'profile';
            profileElement.style.border = "1px solid #333";
            profileElement.style.padding = "10px";
            profileElement.style.margin = "10px 0";
            
            // Populate the profile element with data
            profileElement.innerHTML = `
                <p><strong>Customer Name:</strong> ${profile.field2}</p>
                <p><strong>Contract period Start Date:</strong> ${profile.field5}</p>
                <p><strong>Due Date:</strong> ${dueDate}</p>
                <p><strong>Phone Number:</strong> ${profile.field6}</p>
            `;

            // Append the profile element to the search results container
            searchResultsDiv.appendChild(profileElement);
        });

        if (filteredProfiles.length === 0) {
            searchResultsDiv.innerHTML = '<p>No profiles found with a valid due date.</p>';
        }
    })
    .catch((error) => {
        console.error('Error fetching profiles:', error);
    });
</script>

<script>
    // Function to check for required cookies
    function checkLoginStatus() {
        // Get cookies
        const cookies = document.cookie.split('; ').reduce((acc, cookie) => {
            const [name, value] = cookie.split('=');
            acc[name] = value;
            return acc;
        }, {});

        // Check for email and token cookies
        const email = cookies['email'];
        const token = cookies['token'];

        if (!email || !token) {
            alert("You have not been logged in. Please log in.");
            window.location.href = 'index.html'; // Redirect to index.html
        }
    }

    // Call the function to check login status on page load
    checkLoginStatus();
</script>
</body>
</html>
