<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Updation Page</title>
    <link href="css/i.css" rel="stylesheet">
    <style>
        .popup {
            display: none; /* Initially hidden */
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Higher z-index to sit above other elements */
        }
        .popup-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 400px;
        }
        .close-btn, .submit-btn {
            margin-top: 10px;
            padding: 10px;
            cursor: pointer;
        }
        .close-btn {
    color: red;
    font-size: 15px;
    font-weight: bold;
    position: absolute;
    right: 10px;
    top: 10px;
    cursor: pointer;
}

/* Basic styles for the container */
.installation-form {
            position: relative; /* Position relative for dropdown */
            max-width: 400px;
            margin: 20px auto;
        }

        /* Style for the suggestions dropdown */
        #suggestions-list {
            border: 0px solid #ccc;
            border-top: none;
            max-height: 125px;
            overflow-y: auto;
            list-style-type: none;
            padding: 0;
            margin: 0;
            position: absolute;
            background-color: white;
            z-index: 1000;
            width: 62%;
            margin-left: 360px;
            margin-top: 0px;
        }

        /* Style for each suggestion */
        #suggestions-list li {
            padding: 10px; /* Add some padding */
            cursor: pointer; /* Change cursor to pointer */
        }

        /* Highlight suggestions on hover */
        #suggestions-list li:hover {
            background-color: #f0f0f0; /* Highlight on hover */
        }
        /* Navbar links */
    .navbar-links {
            display: flex;
            list-style-type: none;
            gap: 22px; /* Adds space between each menu item */
        }

        

        .navbar-links a {
            text-decoration: none;
            color: white;
            padding: 8px 11px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        /* Mobile View */
        @media (max-width: 768px) {
            .navbar-links {
                flex-direction: column; /* Stack items vertically */
                gap: 0px;
            }
            .navbar-item.left {
    flex: 0 0 62%;
    display: flex;
    align-items: center;
    padding-left: 15px;
}
            .navbar-links li {
                margin-bottom: 0px; /* Optional, adds space between menu items in mobile view */
                margin-right: 0px;
            }
        }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="navbar-item left">
            <img src="img/Screenshot from 2024-09-27 11-50-56.png" alt="Logo" class="logo">
        </div>
        <div>
          <!-- <button class="menu-btn" onclick="toggleMenu()">â˜°</button> -->
            <ul class="navbar-links">
                <li><a href="index.html">Login</a></li>
                <li><a href="Add_client.html">Add Client</a></li>
                <li><a href="customer-updation.html">Update Client</a></li>
                <li><a href="search.html">Search</a></li>
            </ul>
        </div>
        <div class="navbar-item middle"></div>
        <div class="navbar-item right"></div>
    </header>
    <br>
    <div class="installation-form">
        <h2>Customers List</h2>
        <div class="form-group">
            <label for="customer-name"><strong>Customer Name: </strong></label>
            <input type="text" id="customer-name" name="customer-name" placeholder="Enter Customer Name" required oninput="filterCustomers()">
            <ul id="suggestions-list"></ul> <!-- Suggestions will be displayed here -->
        </div>
    </div>
    
    
    <header class="sub-navbar">
        <div class="navbar-item left">
            <h3 style="margin: 0; color:#00bfa6 ;">Customer Updation Form</h3>
        </div>
        <div class="navbar-item middle"></div>
        <div class="navbar-item right"></div>
    </header>
         
    <div class="installation-form1">
        <div class="form-group">
            <label for="contract-period"><strong>PM Done Date: </strong></label>
            <input type="date" id="contract-period" name="contract-period" required class="styled-input" onchange="setCookie('field25', this.value)">
        </div>

        <div class="form-group">
            <label for="region"><strong>Payment Status: </strong></label>
            <select id="region" name="region" required class="styled-select" onchange="setCookie('field26', this.value)">
                <option value="">Please Select</option>
                <option value="Received">Received</option>
                <option value="Not Received">Not Received</option>
                <option value="On Hold">On Hold</option>
                <option value="Others">Others</option>
            </select>
        </div>
    </div>
        
    <div class="installation-form1">
        <div class="form-group">
            <label for="po-document"><strong>PO Document: </strong></label>
            <input type="file" id="po-document" name="po-document" accept="image/*" multiple required>
        </div>
    
        <!-- Popup for Image Preview -->
        <div id="preview-popup" class="popup">
            <span class="close-btn" onclick="closePopup()">&times;</span>
            <div class="popup-content" id="popup-content"></div>
        </div>
    </div>

    <div class="installation-form1">
        <div class="form-group">
            <label for="comments"><strong>Updated Comments: </strong></label>
            <textarea id="comments" name="comments" placeholder="Enter Comments" required class="styled-textarea" oninput="setCookie('field27', this.value)"></textarea>
        </div>
    </div>

    <button class="next-button" onclick="handleNext()">Next</button>
    <br>
    <!-- Popup for Review Details -->
    <div id="details-popup" class="popup">
        <div class="popup-content">
            <h3>Review Your Details</h3>
            <div id="details-content"></div>
            <button class="close-btn" onclick="closeDetailsPopup()">Close</button>
            <button class="submit-btn" onclick="submitForm()">Submit</button>
        </div>
    </div>
    
    <script>
        function setCookie(name, value) {
            document.cookie = name + "=" + value + "; path=/";
        }

        let modifiedImageUrls = []; // Array to store modified image URLs

        document.getElementById('po-document').addEventListener('change', function (event) {
            const files = event.target.files;
            const popupContent = document.getElementById('popup-content');

            // Clear previous content
            popupContent.innerHTML = '';

            // Show popup
            const popup = document.getElementById('preview-popup');
            popup.style.display = 'flex';

            // Loop through the files and create image elements
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '100px'; // Set max width for preview images
                    img.style.margin = '5px'; // Add some margin
                    popupContent.appendChild(img);

                    // Send the image to the API
                    uploadImage(file);
                };
                reader.readAsDataURL(file);
            }
        });

        // Function to close the popup
        function closePopup() {
            const popup = document.getElementById('preview-popup');
            popup.style.display = 'none';
        }

        // Function to handle Next button click
        function handleNext() {
            const customerName = document.getElementById('customer-name').value;
            const pmDoneDate = document.getElementById('contract-period').value;
            const paymentStatus = document.getElementById('region').value;
            const comments = document.getElementById('comments').value;

            const detailsContent = document.getElementById('details-content');
            detailsContent.innerHTML = `
                <p><strong>Customer Name:</strong> ${customerName}</p>
                <p><strong>PM Done Date:</strong> ${pmDoneDate}</p>
                <p><strong>Payment Status:</strong> ${paymentStatus}</p>
                <p><strong>Comments:</strong> ${comments}</p>
            `;

            // Show details popup
            const detailsPopup = document.getElementById('details-popup');
            detailsPopup.style.display = 'flex';
        }

        // Function to close the details popup
        function closeDetailsPopup() {
            const detailsPopup = document.getElementById('details-popup');
            detailsPopup.style.display = 'none';
        }

        // Function to submit the form (You can customize the submission logic)
        function submitForm() {
            // Here you can include the logic to submit the form data
            alert('Form submitted successfully!');
            closeDetailsPopup(); // Close the details popup after submission
        }

        // Function to upload images to the API
        function uploadImage(file) {
            const myHeaders = new Headers();
            myHeaders.append("Authorization", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MjgzNjM2NjAsImlhdCI6MTcyODI3NzI2MCwidXNlciI6eyJpZCI6MTgsImNyZWF0ZWRfYXQiOiIyMDI0LTA5LTAzVDA0OjU0OjMwLjk4Njc1OCIsInVwZGF0ZWRfYXQiOm51bGwsImZpcnN0bmFtZSI6Inl1bnVzIiwibGFzdG5hbWUiOiJmYXJvbyIsImVtYWlsIjoia2FrYWg2ODk0NEBkYXlwZXkuY29tIiwiaXNfYWRtaW4iOmZhbHNlLCJpc19hY3RpdmF0ZWQiOmZhbHNlfX0.fwkfZy1oqNIkzYAD5hdkXRHYtJl7C-JMDK-jGYMHRwE"); // Replace {{Autho}} with your actual authorization token

            const formdata = new FormData();
            formdata.append("file", file, file.name); // Use the actual file name

            const requestOptions = {
                method: "POST",
                headers: myHeaders,
                body: formdata,
                redirect: "follow"
            };

            fetch("https://api2.itstrending.in/api/v1/profiles/upload_images", requestOptions)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json(); // Parse JSON response
                })
                .then((result) => {
                    console.log(result); // Log the entire result for debugging
                    if (result.status === "success" && result.data && result.data.images) {
                        // Extract the image URLs, modify them, and store in the array
                        result.data.images.forEach(imageUrl => {
                            console.log(imageUrl); // Log the raw image URL
                            const modifiedImageUrl = imageUrl + "?alt=media"; // Append ?alt=media
                            modifiedImageUrls.push(modifiedImageUrl); // Store the modified URL in the array
                        });

                        // Join the modified image URLs into a string and store in cookies
                        const imageUrlsString = modifiedImageUrls.join(','); // Join without brackets
                        setCookie('field18', imageUrlsString); // Save to cookie
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                });
        }
        
        const myHeaders = new Headers();
myHeaders.append("Authorization", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MjgzOTI4NjgsImlhdCI6MTcyODMwNjQ2OCwidXNlciI6eyJpZCI6MTgsImNyZWF0ZWRfYXQiOiIyMDI0LTA5LTAzVDA0OjU0OjMwLjk4Njc1OCIsInVwZGF0ZWRfYXQiOm51bGwsImZpcnN0bmFtZSI6Inl1bnVzIiwibGFzdG5hbWUiOiJmYXJvbyIsImVtYWlsIjoia2FrYWg2ODk0NEBkYXlwZXkuY29tIiwiaXNfYWRtaW4iOmZhbHNlLCJpc19hY3RpdmF0ZWQiOmZhbHNlfX0.xc2myVxA6o3aHJxbHZB6ge5bOxozof6JNPO2Pn17cnA");
myHeaders.append("Content-Type", "application/json");

let customerNames = []; // Array to hold customer names

// Fetch customer names from the API
fetch("https://api.itstrending.in:5000/api/v1/profiles/search_multiple", {
    method: "POST",
    headers: myHeaders,
    body: JSON.stringify({ "field48": "" }),
    redirect: "follow"
})
    .then((response) => response.json())
    .then((result) => {
        // Extract profiles from the result
        const profiles = result.data.profile;

        // Populate the customerNames array with descriptions (names)
        customerNames = profiles.map(profile => profile.field2);
    })
    .catch((error) => console.error('Error:', error));

// Function to filter and display customer names in the dropdown
function filterCustomers() {
    const input = document.getElementById("customer-name");
    const filter = input.value.toLowerCase();
    const suggestionsList = document.getElementById("suggestions-list");

    // Clear previous suggestions
    suggestionsList.innerHTML = "";

    // If there's no input, return
    if (!filter) return;

    // Filter customer names based on the input
    const filteredNames = customerNames.filter(name => name.toLowerCase().includes(filter));

    // Populate the suggestions list with filtered names
    filteredNames.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name; // Set the text content of the list item
        li.onclick = () => {
            input.value = name; // Set the input value to the selected name
            suggestionsList.innerHTML = ""; // Clear suggestions after selection
            fetchCustomerData(name); // Fetch customer data for the selected name
        };
        suggestionsList.appendChild(li); // Append the list item to the suggestions list
    });
}

// Function to fetch customer data based on the entered name
function fetchCustomerData(customerName) {
    const raw = JSON.stringify({
        "field2": customerName // Use the entered name in the request body
    });

    const requestOptions = {
        method: "POST",
        headers: myHeaders,
        body: raw,
        redirect: "follow"
    };

    fetch("https://api.itstrending.in:5000/api/v1/profiles/search_multiple", requestOptions)
        .then(response => response.json())
        .then(result => {
            // Handle the fetched customer data
            console.log('Fetched customer data:', result);

            // Extract the profile_id from the response
            const profileId = result.data.profile[0].profile_id;
            console.log('Profile ID:', profileId);

            // Retrieve the email from cookies
            const email = decodeURIComponent(getCookie('email') || '');
            console.log('Email from cookies:', email);

            // Send the profile_id and email to the second API
            fetchProfileDetails(profileId, email);
        })
        .catch(error => console.error('Error fetching customer data:', error));
}

// Function to send the profile_id and email to the API
function fetchProfileDetails(profileId, email) {
    const raw = JSON.stringify({
        "profile_id": profileId,
        "email": email
    });

    const requestOptions = {
        method: "POST",
        headers: myHeaders,
        body: raw,
        redirect: "follow"
    };

    fetch("https://api.itstrending.in:5000/api/v1/profiles/get_profile_details", requestOptions)
        .then(response => response.json())
        .then(result => {
            // Log the result in the console
            console.log('Profile details fetched:', result);
        })
        .catch(error => console.error('Error fetching profile details:', error));
}

// Function to get a cookie by name
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}


// put api code starts from here

// Profile data structure
let profileData = {
            "profile_id" : "",
            "description": "",
            "gender": "",
            "images":  "",
            "bio":"",
            "field1": "",
            "field2": "",
            "field3": "",
            "field4": "",
            "field5": "",
            "field6": "",
            "field7": "",
            "field8": "",
            "field9": "",
            "field10": "",
            "field11": "",
            "field12": "",
            "field13": "",
            "field14": "",
            "field15": "",
            "field16": "",
            "field17": "",
            "field18": "",
            "field19": "",
            "field20": "",
            "field21": "",
            "field22": "",
            "field23": "",
            "field24": "",
            "field25": "",
            "field26": "",
            "field27": "",
            "field28": "",
            "field29": "",
            "field30": "",
            "field31": "",
            "field32": "",
            "field33": "",
            "field34": "",
            "field35": "",
            "field36": "",
            "field37": "",
            "field38": "",
            "field39": "",
            "field40": "",
            "field41": "",
            "field42": "",
            "field43": "",
            "field44": "",
            "field45": "",
            "field46": "",
            "field47": "",
            "field48": "",
            "field49": "",
            "field50": ""
        };

        // Function to populate profile data from API response
        function populateProfileData(apiResponse) {
            const profile = apiResponse.data.profile[0]; // Assuming one profile
            
            // Map fields from the API response to profileData
            profileData.profile_id = profile.profile_id || "";
            profileData.description = profile.description || "";
            profileData.gender = profile.gender || "";
            profileData.images = profile.images || "";
            profileData.bio = profile.bio || "";
            profileData.field1 = profile.field1 || "";
            profileData.field2 = profile.field2 || "";
            profileData.field3 = profile.field3 || "";
            profileData.field4 = profile.field4 || "";
            profileData.field5 = profile.field5 || "";
            profileData.field6 = profile.field6 || "";
            profileData.field7 = profile.field7 || "";
            profileData.field8 = profile.field8 || "";
            profileData.field9 = profile.field9 || "";
            profileData.field10 = profile.field10 || "";
            profileData.field11 = profile.field11 || "";
            profileData.field12 = profile.field12 || "";
            profileData.field13 = profile.field13 || "";
            profileData.field14 = profile.field14 || "";
            profileData.field15 = profile.field15 || "";
            profileData.field16 = profile.field16 || "";
            profileData.field17 = profile.field17 || "";
            profileData.field18 = profile.field18 || "";
            profileData.field19 = profile.field19 || "";
            profileData.field20 = profile.field20 || "";
            profileData.field21 = profile.field21 || "";
            profileData.field22 = profile.field22 || "";
            profileData.field23 = profile.field23 || "";
            profileData.field24 = profile.field24 || "";
            profileData.field25 = profile.field25 || "";
            profileData.field26 = profile.field26 || "";
            profileData.field27 = profile.field27 || "";
            profileData.field28 = profile.field28 || "";
            profileData.field29 = profile.field29 || "";
            profileData.field30 = profile.field30 || "";
            profileData.field31 = profile.field31 || "";
            profileData.field32 = profile.field32 || "";
            profileData.field33 = profile.field33 || "";
            profileData.field34 = profile.field34 || "";
            profileData.field35 = profile.field35 || "";
            profileData.field36 = profile.field36 || "";
            profileData.field37 = profile.field37 || "";
            profileData.field38 = profile.field38 || "";
            profileData.field39 = profile.field39 || "";
            profileData.field40 = profile.field40 || "";
            profileData.field41 = profile.field41 || "";
            profileData.field42 = profile.field42 || "";
            profileData.field43 = profile.field43 || "";
            profileData.field44 = profile.field44 || "";
            profileData.field45 = profile.field45 || "";
            profileData.field46 = profile.field46 || "";
            profileData.field47 = profile.field47 || "";
            profileData.field48 = profile.field48 || "";
            profileData.field49 = profile.field49 || "";
            profileData.field50 = profile.field50 || "";

        }

        // Function to get a specific cookie by name
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Function to fetch new field values from cookies
        function fetchNewFieldValues() {
            profileData.field25 = getCookie('field25') || profileData.field25;
            profileData.field26 = getCookie('field26') || profileData.field26;
            profileData.field27 = getCookie('field27') || profileData.field27;
        }

        // Function to submit the form and send the PUT request
        function submitForm() {
            // Fetch updated field values from cookies
            fetchNewFieldValues();

            // Prepare headers for the request
            const myHeaders = new Headers();
            myHeaders.append("Authorization", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MjgzNjM2NjAsImlhdCI6MTcyODI3NzI2MCwidXNlciI6eyJpZCI6MTgsImNyZWF0ZWRfYXQiOiIyMDI0LTA5LTAzVDA0OjU0OjMwLjk4Njc1OCIsInVwZGF0ZWRfYXQiOm51bGwsImZpcnN0bmFtZSI6Inl1bnVzIiwibGFzdG5hbWUiOiJmYXJvbyIsImVtYWlsIjoia2FrYWg2ODk0NEBkYXlwZXkuY29tIiwiaXNfYWRtaW4iOmZhbHNlLCJpc19hY3RpdmF0ZWQiOmZhbHNlfX0.fwkfZy1oqNIkzYAD5hdkXRHYtJl7C-JMDK-jGYMHRwE"); // Authorization token placeholder
            myHeaders.append("Content-Type", "application/json");

            // Convert profileData to JSON for the PUT request
            const raw = JSON.stringify(profileData);

            // Prepare request options
            const requestOptions = {
                method: "PUT",
                headers: myHeaders,
                body: raw,
                redirect: "follow"
            };

            // Make the API request
            fetch("https://api.itstrending.in:5000/api/v1/profiles", requestOptions)
                .then((response) => response.text())
                .then((result) => {
                    console.log("Profile updated successfully:", result);
                    alert('Profile updated successfully!'); // Notify the user
                })
                .catch((error) => console.error("Error updating profile:", error));
        }

    </script>
  
    
</body>
</html>
